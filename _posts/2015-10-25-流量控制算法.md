---
id: 548
layout: post
title: 'æµé‡æ§åˆ¶ç®—æ³•'
date: 2015-10-25 19:24:00
author: virusdefender
tags: 
---

å¾ˆå¤šåœºæ™¯ä¸‹éƒ½éœ€è¦æµé‡æ§åˆ¶ï¼Œä»åº•å±‚çš„æ•°æ®åŒ…ä¼ è¾“åˆ°è´­ç‰©ç§’æ€ã€‚

å¸¸è§çš„æµé‡æ§åˆ¶ç®—æ³•æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯æ¼æ¡¶ç®—æ³•ï¼Œæ¡¶æœ¬èº«å…·æœ‰ä¸€ä¸ªæ’å®šçš„é€Ÿç‡å¾€ä¸‹æµæ°´ï¼Œè€Œä¸Šæ–¹ä¸€ç›´æœ‰æ°´è¿›å…¥æ¡¶ä¸­ã€‚å½“æ¡¶è¿˜æœªæ»¡æ—¶ï¼Œä¸Šæ–¹çš„æ°´å¯ä»¥åŠ å…¥ã€‚ä¸€æ—¦æ°´æ»¡ï¼Œä¸Šæ–¹çš„æ°´å°±æº¢å‡ºï¼Œå¯ä»¥è®¤ä¸ºè¯·æ±‚è¢«ä¸¢å¼ƒã€‚

è¿™ä¸ªç®—æ³•ä¸éš¾ç†è§£ï¼Œå¯ä»¥ä¿è¯ç³»ç»Ÿçš„ç¨³å®šï¼Œå› ä¸ºæ°´æµå‡ºçš„é€Ÿåº¦ä¸€ç›´æ˜¯ä¸å˜çš„ï¼Œå³ä½¿åœ¨æœ‰çªå‘æµé‡çš„æƒ…å†µä¸‹ã€‚ä½†æ˜¯å¦‚æœåˆ°äº†ç½‘ç«™ç§’æ€çš„æƒ…å¢ƒä¸‹ï¼Œæœ‰çªå‘æµé‡ï¼Œè¿™ä¸ªç®—æ³•å°±ä¸å¥½ç”¨äº†ã€‚æ›´å¸¸ç”¨çš„æ˜¯ä»¤ç‰Œé€šç®—æ³•ã€‚

ä»¤ç‰Œæ¡¶è¿˜æ˜¯å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªç››æ»¡äº†ä»¤ç‰Œçš„ç®±å­ï¼Œæ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚å°±ä¼šæ‹¿èµ°ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œæ²¡æœ‰äº†ï¼Œè¯·æ±‚å°±ä¼šå¤±è´¥ã€‚è€Œæ ¹æ®é€Ÿç‡é™åˆ¶ï¼Œä»¤ç‰Œè¿˜æ˜¯ä¸€ç›´åœ¨æ·»åŠ çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰ä¸€éƒ¨åˆ†çš„è¯·æ±‚æ˜¯å¯ä»¥æ…¢æ…¢çš„æ‹¿åˆ°ä»¤ç‰Œçš„ã€‚è€Œä¸€å¼€å§‹ç®±å­é‡Œé¢æ˜¯æœ‰ä¸€äº›ä»¤ç‰Œçš„ï¼Œä¸€å¼€å§‹çš„çªå‘æµé‡éƒ½å¯ä»¥æˆåŠŸçš„æ‹¿åˆ°ä»¤ç‰Œã€‚

æ ¹æ® https://github.com/celery/kombu/blob/master/kombu/utils/limits.py ï¼Œ æˆ‘ç®€å•æ”¹å†™äº†ä¸€ä¸‹ï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹å‡ºæ¥æµé‡æ§åˆ¶ç»“æœã€‚

```python
# coding=utf-8
import time


class TokenBucket(object):
    def __init__(self, fill_rate, capacity):
        self.capacity = float(capacity)
        self._left_tokens = capacity
        self.fill_rate = float(fill_rate)
        self.timestamp = time.time()

    def consume(self, tokens=1):
        """Return :const:`True` if the number of tokens can be consumed
        from the bucket.  If they can be consumed, a call will also consume the
        requested number of tokens from the bucket. Calls will only consume
        `tokens` (the number requested) or zero tokens -- it will never consume
        a partial number of tokens."""
        if tokens <= self.tokens:
            self._left_tokens -= tokens
            return True
        return False

    def expected_time(self, tokens=1):
        """Return the time (in seconds) when a new token is expected
        to be available. This will not consume any tokens from the bucket."""
        _tokens = self.tokens
        tokens = max(tokens, _tokens)
        return (tokens - _tokens) / self.fill_rate

    @property
    def tokens(self):
        if self._left_tokens < self.capacity:
            now = time.time()
            delta = self.fill_rate * (now - self.timestamp)
            self._left_tokens = min(self.capacity, self._left_tokens + delta)
            self.timestamp = now
        return self._left_tokens


true = false = 0

# æ¯ç§’å¾€æ¡¶é‡Œé¢æ·»åŠ 5ä¸ªä»¤ç‰Œï¼Œæ¡¶çš„å¤§å°æ˜¯50
bucket = TokenBucket(fill_rate=5, capacity=50)
for i in range(300):
    time.sleep(0.1)
    if bucket.consume():
        true += 1
        print "Accepted", i
    else:
        false += 1
        print "Dropped, time left ", bucket.expected_time()
print true, false
```

è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä¸Šé¢çš„demoä»£ç æ˜¯å­˜åœ¨å­˜åœ¨å¹¶å‘ç«æ€æ¡ä»¶é—®é¢˜çš„ï¼Œä½†æ˜¯å‡ºäºæ€§èƒ½å’Œç®€åŒ–å†™æ³•çš„è€ƒè™‘ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥æ¥å—çš„ï¼Œæ¯•ç«Ÿæµé‡é™åˆ¶ä¸€èˆ¬ä¹Ÿä¸éœ€è¦å¤ªç²¾ç¡®ã€‚