<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-language" content="zh-cn">
    <title>æµ‹è¯•é©±åŠ¨æ–‡æ¡£åœ¨åç«¯ API å¼€å‘ä¸­çš„å®è·µ - virusdefender's blog (ï¼¾ï¼ï¼¾)V</title>
    <link rel="shortcut icon" href="https://cdn.virusdefender.net/assets/img/favicon.ico">
    <meta name="author"  content="virusdefender">
    <meta name="description" content="å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†">
    <meta name="keywords"  content="virusdefender,blog">
    <!-- Open Graph -->
    <meta property="og:title" content="æµ‹è¯•é©±åŠ¨æ–‡æ¡£åœ¨åç«¯ API å¼€å‘ä¸­çš„å®è·µ - virusdefender's blog (ï¼¾ï¼ï¼¾)V">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://strcpy.me/index.php/archives/772/">
    <meta property="og:description" content="å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†">
    <meta property="og:site_name" content="virusdefender's blog (ï¼¾ï¼ï¼¾)V">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/github-markdown.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/prism.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/app.min.css">
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="https://strcpy.me/feed/" />
</head>

<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
<![endif]-->
    <header class="g-header">
    <div class="g-logo">
        <a href="/">virusdefender's blog (ï¼¾ï¼ï¼¾)V</a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/index.php/archives/job/">job</a></li>
            
            <li><a href="/index.php/archives/about/">about</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
             
            
            <a href="/tags/#Django" class="post-tag">Django</a>
            
            
        </div>
        <h1>æµ‹è¯•é©±åŠ¨æ–‡æ¡£åœ¨åç«¯ API å¼€å‘ä¸­çš„å®è·µ</h1>
        <div class="post-meta">
            <time class="post-meta-item" datetime="2017-07-23 12:39"><i class="iconfont icon-date"></i>2017-07-23 12:39</time>
        </div>
    </div>
</header>

<div class="post-content">
    
    <article class="markdown-body">
        <p>å¾ˆå¤šäººäº†è§£è¿‡ <a href="https://docs.python.org/2/library/doctest.html">Python çš„ doctest</a>ï¼Œæ˜¯ä»æ³¨é‡Šä¸­å†™æµ‹è¯•ï¼Œæˆ‘ä»¬ç°åœ¨åå‘æ€ç»´ï¼Œä»æµ‹è¯•ç”Ÿæˆæ–‡æ¡£ã€‚</p>

<h2 id="ç°çŠ¶">ç°çŠ¶</h2>

<p>åœ¨å¼€å¤´æœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹ç°åœ¨åç«¯ API çš„å¼€å‘æ¨¡å¼ï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½çš„ç†è§£é‡åˆ°çš„é—®é¢˜ã€‚</p>

<ul>
  <li>æ¡†æ¶: Django</li>
  <li>ç»™å‰ç«¯æä¾›çš„éƒ½æ˜¯ JSON APIï¼Œæ²¡æœ‰åç«¯æ¸²æŸ“çš„ç½‘é¡µ</li>
  <li>æ‰€æœ‰çš„ API éƒ½ç»§æ‰¿ <code class="highlighter-rouge">APIView</code>ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ Django REST frameworkï¼ˆä»¥ä¸‹ç®€ç§° DRFï¼Œåå­—å¤ªé•¿äº†ï¼‰ ä¸­çš„ <code class="highlighter-rouge">APIView</code>ï¼Œè¿™ä¸ªåé¢ä¼šè¯´åŸå› </li>
  <li>ä½¿ç”¨ DRF ä¸­çš„éƒ¨åˆ† serializer æ¥åšæ•°æ®æ ¼å¼éªŒè¯å’Œ QuerySet è½¬æ¢ä¸º Python å­—å…¸åˆ—è¡¨ç­‰ç±»å‹çš„å·¥ä½œ</li>
</ul>

<p>DRF åº“æä¾›äº†å¾ˆå¤šæˆ‘ä»¬å¹¶ä¸ä¼šç”¨åˆ°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚</p>

<ul>
  <li>ç™»å½•éªŒè¯ï¼Œæƒé™ç®¡ç†ï¼ŒAPI ç‰ˆæœ¬å·ç®¡ç†ï¼Œé™æµã€è‡ªåŠ¨ç¿»é¡µç­‰ç­‰ï¼Œè¿™äº›æˆ‘ä»¬æ›´ä¾§é‡ç‹¬ç«‹å’Œæ‰‹åŠ¨çš„å¤„ç†ã€‚</li>
  <li><code class="highlighter-rouge">Generic Views</code> ä¸€ç›´æ˜¯ä¸€ä¸ªè®©æˆ‘æ„Ÿåˆ°ç–‘æƒ‘çš„ä¸œè¥¿ï¼Œçœ‹ä¼¼å†™èµ·æ¥ç®€å•ï¼Œä»£ç é‡å¾ˆå°‘ï¼Œåƒæ˜¯å¡«å……ä¸€äº›é¢„å®šä¹‰çš„å˜é‡å’Œæ–¹æ³•ï¼Œç®€å•çš„å¢åˆ æŸ¥æ”¹ä¼šæ–¹ä¾¿ä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨å®é™…å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå¯èƒ½å¯¼è‡´é—®é¢˜å¤æ‚åŒ–ï¼Œå¹¶æ²¡æœ‰æ˜¾å¼çš„å†™å‡ºæ“ä½œè¿‡ç¨‹æ›´æ¸…æ™°ã€‚</li>
</ul>

<p>æ‰€ä»¥æˆ‘ä»¬ä»¿ç…§ DRF çš„ APIViewï¼Œç»§æ‰¿ Django çš„ View,è‡ªå·±å†™äº†ä¸€ä¸ªæ–°çš„ <code class="highlighter-rouge">APIView</code>ï¼ŒåŒ…å«äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œè§£æ JSONï¼ŒåŒæ—¶å¢åŠ äº†éƒ¨åˆ†å¸¸ç”¨æ–¹æ³•ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">validate_serializer</code>ã€<code class="highlighter-rouge">self.success</code>ã€<code class="highlighter-rouge">self.error</code> å’Œ <code class="highlighter-rouge">self.paginate</code> ç­‰ç­‰ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€æ®µä¼ªä»£ç </p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserProfileAPI</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="nd">@validate_serializer</span><span class="p">(</span><span class="n">ChangeUserProfileSeralizer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">....</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">"ä¿å­˜å¤±è´¥"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">UserProfileSerailzier</span><span class="p">(</span><span class="n">user_profile</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ProblemAPI</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">Problem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">(),</span> <span class="n">ProblemSerializer</span><span class="p">)))</span>
</code></pre></div></div>

<h2 id="ç°æœ‰çš„æ–‡æ¡£å­˜åœ¨ä»€ä¹ˆé—®é¢˜">ç°æœ‰çš„æ–‡æ¡£å­˜åœ¨ä»€ä¹ˆé—®é¢˜</h2>

<ul>
  <li>æ²¡æœ‰æ–‡æ¡£ï¼Œé â€å£å£ç›¸ä¼ â€å’Œâ€å¿ƒæœ‰çµçŠ€â€ã€‚</li>
  <li>æ‰‹å†™ API æ–‡æ¡£ï¼Œä¸åŒäººå†™å‡ºæ¥çš„å¯èƒ½æ ¼å¼é£æ ¼ç•¥æœ‰å·®å¼‚ï¼Œä¹Ÿä¸å®¹æ˜“ç»Ÿä¸€ç®¡ç†ã€‚æ›´é‡è¦çš„æ˜¯äººéƒ½æ˜¯æ‡’çš„ï¼Œæ²¡æœ‰ç›‘ç£çš„æƒ…å†µä¸‹ï¼Œæ–‡æ¡£èƒ½ä¸å†™å°±ä¸å†™ï¼Œè€Œæµ‹è¯•è¿˜æ˜¯è¦å¿…é¡»è¦å†™çš„ã€‚</li>
  <li>ä¸€å¤„ä¿®æ”¹å¾ˆå¤š API å¯èƒ½éƒ½ä¼šå˜ï¼Œæ¯”å¦‚æŸä¸€ä¸ª Model ä¿®æ”¹äº†å­—æ®µï¼Œå¾ˆå¤š API çš„è¿”å›å€¼éƒ½å¯èƒ½å—åˆ°å½±å“ï¼Œæ‰‹åŠ¨çš„é€ä¸ªä¿®æ”¹å¹¶ä¸ç§‘å­¦ã€‚</li>
  <li>å·²æœ‰çš„æ–‡æ¡£ç”Ÿæˆå·¥å…·è‡ªå®šä¹‰ç¨‹åº¦ä¸é«˜ï¼Œæ¯”å¦‚ <a href="https://github.com/marcgibbons/django-rest-swagger">Django REST Swagger</a> è¦æ±‚ <code class="highlighter-rouge">Generic Views</code> å°±æ”¾å¼ƒäº†ã€‚</li>
  <li>è¿˜æœ‰äº›æ–‡æ¡£ç”Ÿæˆå·¥å…·æ˜¯åœ¨æ³¨é‡Šä¸­ä½¿ç”¨ç‰¹å®šçš„æ ¼å¼æè¿° API å­—æ®µå’Œç»†èŠ‚çš„ï¼Œå…¶å®å’Œæ‰‹å†™æ–‡æ¡£æ²¡æœ‰æœ¬è´¨ä¸Šçš„å·®å¼‚ã€‚</li>
  <li>ä¸Šé¢å‡ æ¡æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šæ‰‹å†™çš„æ–‡æ¡£å¾ˆéš¾è‡ªåŠ¨åŒ–éªŒè¯æ˜¯å¦æ­£ç¡®ï¼Œæµ‹è¯•ç”Ÿæˆæ–‡æ¡£å¯ä»¥ä¿è¯å’Œæµ‹è¯•æ˜¯ä¸€è‡´çš„ã€‚</li>
  <li>è™½ç„¶â€ä»£ç å³æ–‡æ¡£â€ï¼Œä½†æ˜¯ä¹Ÿåªé€‚ç”¨äºé API æ–‡æ¡£ï¼Œæ¯”å¦‚æ•°æ®åº“è®¾è®¡ã€æ¶æ„è®¾è®¡ã€ç®—æ³•è®¾è®¡ç­‰ï¼Œå› ä¸ºä»£ç å¹¶ä¸ä¸€å®šé€‚åˆä¼ æ’­ç»™æ‰€æœ‰äººçœ‹ï¼Œå°¤å…¶æ˜¯ API æ–‡æ¡£ä¸€èˆ¬éƒ½æ˜¯å¯¹å¤–çš„ï¼Œè€Œä¸”ä»£ç ä¸­çš„æ³¨é‡Šç»å¸¸æ˜¯åˆ†æ•£çš„ï¼Œæ–‡æ¡£ä¸Šä¸€ä¸ª API çš„è¯´æ˜ã€è¯·æ±‚ã€å“åº”ç­‰å‡ éƒ¨åˆ†æ•°æ®å¯èƒ½åˆ†æ•£åœ¨å‡ ä¸ªæ–‡ä»¶ä¸­ã€‚</li>
</ul>

<h2 id="æˆ‘ä»¬çš„å®è·µ">æˆ‘ä»¬çš„å®è·µ</h2>

<p>è¦æ”¹è¿›ä¸Šé¢çš„é—®é¢˜ï¼ŒåŸºæœ¬åŸåˆ™æ˜¯å°½é‡å°‘æ”¹åŠ¨å·²æœ‰çš„ä»£ç ï¼Œæ‰€ä»¥ç»è¿‡å’Œ @reverland çš„ä¸€ç•ªè®¨è®ºï¼Œç¡®å®šä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p>

<ul>
  <li>ä½¿ç”¨ serializer ç”Ÿæˆæ•°æ®æ ¼å¼æè¿°æ€§æ–‡æ¡£</li>
  <li>ä½¿ç”¨éƒ¨åˆ†æµ‹è¯•å……å½“ API æ ·ä¾‹æ•°æ®</li>
  <li>CI çš„æ—¶å€™ï¼Œè¯†åˆ« commit ä¿¡æ¯ä¸­çš„<code class="highlighter-rouge">doc deploy</code> åç”Ÿæˆå’Œè‡ªåŠ¨éƒ¨ç½²æ–‡æœ¬ç‰ˆæ–‡æ¡£å’Œ Postman å¯¼å‡ºæ ¼å¼</li>
</ul>

<h3 id="serializer-çš„æ–‡æ¡£">serializer çš„æ–‡æ¡£</h3>

<p>ç”±ä¸€ä¸ª serializer ç”Ÿæˆå¯¹åº”çš„æè¿°æ€§æ–‡æ¡£ç›¸å¯¹æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸€ä¸ªå…¸å‹çš„ serializer æ˜¯è¿™æ ·çš„</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IPOrSubnetField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"help_text"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help_text</span> <span class="o">=</span> <span class="s">"IPv4 çš„ IP æˆ–è€…å­ç½‘å½¢å¼å­—ç¬¦ä¸²"</span>

    <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">CreateRuleSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="s">"""
    ä¸€æ¡è§„åˆ™å¯ä»¥å°ç¦ä¹Ÿå¯ä»¥é™åˆ¶é¢‘ç‡ï¼Œå°ç¦çš„æ—¶å€™ï¼Œä¸éœ€è¦ä¼ é€’ e å’Œ f å­—æ®µã€‚
    """</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="n">RuleAction</span><span class="o">.</span><span class="n">forbid</span><span class="p">,</span> <span class="n">RuleAction</span><span class="o">.</span><span class="n">limit_rate</span><span class="p">])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">allow_blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ListField</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="n">IPOrSubnetField</span><span class="p">())</span>
</code></pre></div></div>

<p>ä¸‹é¢æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„è¡¨æ ¼æ–‡æ¡£</p>

<p>æ•°æ®æ ¼å¼</p>

<blockquote>
  <p>ä¸€æ¡è§„åˆ™å¯ä»¥å°ç¦ä¹Ÿå¯ä»¥é™åˆ¶é¢‘ç‡ï¼Œå°ç¦çš„æ—¶å€™ï¼Œä¸éœ€è¦ä¼ é€’ e å’Œ f å­—æ®µã€‚</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å­—æ®µå</th>
      <th style="text-align: center">æ•°æ®ç±»å‹</th>
      <th style="text-align: center">æ˜¯å¦å¿…å¡«/é»˜è®¤å€¼</th>
      <th style="text-align: center">NULL</th>
      <th style="text-align: center">å…¶ä»–</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">a</td>
      <td style="text-align: center">æ•´å‹æ•°å­—</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">True</td>
      <td style="text-align: center">-</td>
    </tr>
    <tr>
      <td style="text-align: left">b</td>
      <td style="text-align: center">å­—ç¬¦ä¸²</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">True</td>
      <td style="text-align: center">-</td>
    </tr>
    <tr>
      <td style="text-align: left">c</td>
      <td style="text-align: center">å­—ç¬¦ä¸²</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">True</td>
      <td style="text-align: center">-</td>
    </tr>
    <tr>
      <td style="text-align: left">d</td>
      <td style="text-align: center">æŒ‡å®šé€‰é¡¹</td>
      <td style="text-align: center">å¿…å¡«</td>
      <td style="text-align: center">False</td>
      <td style="text-align: center">é€‰é¡¹æ˜¯: [â€˜forbidâ€™, â€˜limit_rateâ€™]</td>
    </tr>
    <tr>
      <td style="text-align: left">e</td>
      <td style="text-align: center">æ•´å‹æ•°å­—</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">True</td>
      <td style="text-align: center">æœ€å°å€¼: 1;</td>
    </tr>
    <tr>
      <td style="text-align: left">f</td>
      <td style="text-align: center">æ•´å‹æ•°å­—</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">True</td>
      <td style="text-align: center">æœ€å°å€¼: 1;</td>
    </tr>
    <tr>
      <td style="text-align: left">g</td>
      <td style="text-align: center">å­—ç¬¦ä¸²</td>
      <td style="text-align: center">éå¿…å¡«/æ— é»˜è®¤å€¼</td>
      <td style="text-align: center">False</td>
      <td style="text-align: center">æœ€å¤§é•¿åº¦: 128; æœ€å°é•¿åº¦: 0ï¼›</td>
    </tr>
    <tr>
      <td style="text-align: left">h</td>
      <td style="text-align: center">åˆ—è¡¨</td>
      <td style="text-align: center">å¿…å¡«</td>
      <td style="text-align: center">False</td>
      <td style="text-align: center">è¯¦è§ä¸‹æ–¹è¡¨æ ¼</td>
    </tr>
  </tbody>
</table>

<p>h</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å­—æ®µå</th>
      <th style="text-align: center">æ•°æ®ç±»å‹</th>
      <th style="text-align: center">æ˜¯å¦å¿…å¡«/é»˜è®¤å€¼</th>
      <th style="text-align: center">NULL</th>
      <th style="text-align: center">å…¶ä»–</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">å­å­—æ®µ</td>
      <td style="text-align: center">å­—ç¬¦ä¸²</td>
      <td style="text-align: center">å¿…å¡«</td>
      <td style="text-align: center">False</td>
      <td style="text-align: center">IPv4 çš„ IP æˆ–è€…å­ç½‘å½¢å¼å­—ç¬¦ä¸²;</td>
    </tr>
  </tbody>
</table>

<p>è¿™ä¸ªè¡¨æ ¼åŒ…å«äº†å­—æ®µåã€æ•°æ®ç±»å‹ã€æ•°æ®æ ¼å¼ã€å­—æ®µé¢å¤–è¯´æ˜ç­‰å‡ éƒ¨åˆ†ä¿¡æ¯ã€‚</p>

<ul>
  <li>ä¸€ä¸ª serializer çš„æ‰€æœ‰å­—æ®µå¯ä»¥åœ¨ <code class="highlighter-rouge">serializer.fields.items()</code> ä¸­å¾—åˆ°ï¼Œåªè¦éå†ä¸€ä¸‹æ‰€æœ‰çš„å­—æ®µå°±ä¸éš¾å†é’ˆå¯¹æ€§çš„å¤„ç†ã€‚</li>
  <li>å­—æ®µçš„ç±»å‹å¾ˆå®¹æ˜“æ¨æ–­ï¼Œ<code class="highlighter-rouge">is_instance(field, serializers.IntegerField)</code> ç­‰é€ä¸ªçš„æ¯”è¾ƒå°±å¯ä»¥çŸ¥é“ã€‚</li>
  <li>å‡ ä¹æ‰€æœ‰çš„å­—æ®µéƒ½æ”¯æŒ <code class="highlighter-rouge">required</code> å’Œ <code class="highlighter-rouge">null</code> å‚æ•°ï¼Œä»£è¡¨æ˜¯å¦å…è®¸ä¸ä¼ é€’è¯¥å­—æ®µå’Œæ˜¯å¦å…è®¸è¯¥å­—æ®µçš„å€¼ä¸º <code class="highlighter-rouge">null</code>ã€‚å¯¹äºå­—ç¬¦ä¸²ç±»å‹å’Œæ•°æ®ç±»å‹çš„å­—æ®µç­‰ï¼Œè¿˜æ”¯æŒ <code class="highlighter-rouge">max_length / max_value</code> å’Œ <code class="highlighter-rouge">min_length / min_value</code> å‚æ•°ï¼Œä»£è¡¨æ•°æ®çš„èŒƒå›´ï¼Œå…¶ä»–çš„ä¸ªåˆ«æ ¼å¼é™åˆ¶å¯ä»¥å‚è€ƒä¸‹ DRF çš„æºç ã€‚</li>
  <li>æœ‰çš„å­—æ®µéœ€è¦é¢å¤–è¯´æ˜æ‰æ–¹ä¾¿ç†è§£ï¼Œæˆ–è€…æœ‰äº›å­—æ®µæ˜¯äº’æ–¥çš„ï¼Œä¸å¯ä»¥åŒæ—¶ä¼ é€’ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯è¦æ”¯æŒåœ¨ä»£ç ä¸­è‡ªæˆ‘æè¿°çš„åŠŸèƒ½ï¼Œè¿™äº›è¯´æ˜æœ‰ä¸¤å¤„æ¥æºï¼Œä¸€ä¸ªæ˜¯ serializer çš„ <code class="highlighter-rouge">doc string</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ field çš„ <code class="highlighter-rouge">help_text</code> å±æ€§ã€‚</li>
</ul>

<p>åœ¨å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼ŒClient ä¼šä¼ é€’ä¸€ä¸ªç‰¹æ®Šçš„ HTTP å¤´ï¼Œè¿™æ · <code class="highlighter-rouge">@validate_serializer</code> å°±çŸ¥é“æ˜¯å¦è¦ç”Ÿæˆ serializer çš„æ–‡æ¡£äº†ã€‚</p>

<h3 id="apiæ•°æ®çš„æ–‡æ¡£">APIæ•°æ®çš„æ–‡æ¡£</h3>

<p>ä¸€ä¸ª API ä»…ä»…æœ‰æ•°æ®æ ¼å¼çš„è¦æ±‚æ˜¯ä¸å¤Ÿçš„ï¼Œæœ€å¥½è¿˜èƒ½å¤Ÿæä¾›ä¸€äº›å¸¸è§çš„æ­£ç¡®å’Œé”™è¯¯ä½¿ç”¨çš„ä¾‹å­ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å¸®åŠ©ç”¨æˆ·å»æ›´å¥½çš„ç†è§£ API çš„ç”¨é€”ï¼Œå•å…ƒæµ‹è¯•çš„æµ‹è¯•ç”¨ä¾‹å°±æ˜¯è¿™äº›ç¤ºä¾‹æœ€å¥½çš„æ¥æºã€‚</p>

<p>ä¸€ä¸ªå…¸å‹çš„å•å…ƒæµ‹è¯•æ˜¯è¿™æ ·å­çš„</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ACLAPITest</span><span class="p">(</span><span class="n">APITestCase</span><span class="p">):</span>
    <span class="nd">@document</span>
    <span class="k">def</span> <span class="nf">test_create_acl_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        åˆ›å»º acl è§„åˆ™ï¼Œåªæœ‰ cidr
        """</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSuccess</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="o">...</span>        
        <span class="k">return</span> <span class="n">resp</span>
    
    <span class="nd">@document</span>
    <span class="k">def</span> <span class="nf">test_edit_acl_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        ç¼–è¾‘ acl è§„åˆ™
        """</span>
        <span class="n">rule_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_create_acl_rule_ip</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">"data"</span><span class="p">][</span><span class="s">"id"</span><span class="p">]</span>
        <span class="o">...</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">new_rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSuccess</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="o">...</span>
</code></pre></div></div>

<p>è¿™é‡Œæµ‹è¯•åˆ›å»ºå’Œç¼–è¾‘ ACL è§„åˆ™ã€‚<code class="highlighter-rouge">@document</code> æ˜¯æ ‡è®°è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹è¦ç”Ÿæˆæ–‡æ¡£ã€‚æˆ‘ä»¬é€šè¿‡ä¿®æ”¹ Client çš„å±æ€§æ¥å®ç°ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_testMethodName</span> <span class="o">==</span> <span class="n">method</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">test_method_name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_testMethodName</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">__doc__</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">running_module</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">return</span> <span class="n">handle</span>
</code></pre></div></div>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰ä¿®é¥°åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„æµ‹è¯•ä¸Šï¼Œæ‰ä¼šå»æ›´æ–°è¿™äº›å±æ€§ï¼Œå¦åˆ™è¿è¡Œ <code class="highlighter-rouge">test_edit_acl_rule</code> çš„æ—¶å€™ï¼Œ<code class="highlighter-rouge">test_create_acl_rule</code> ä¼šæŠŠ Client çš„å±æ€§æ”¹é”™ã€‚</p>

<p>æµ‹è¯•ä¸­çš„ Client å°±æ˜¯ä¸€ä¸ªç”Ÿæˆ HTTP è¯·æ±‚ï¼Œç„¶åæ¨¡æ‹Ÿå‘é€è¯·æ±‚çš„ç»„ä»¶ï¼Œè¦æƒ³è®°å½•ä¸‹è¯·æ±‚å’Œå“åº”çš„å†…å®¹ï¼Œæ›¿æ¢æ‰ DRF åŸç”Ÿ Client æ˜¯å¿…é¡»çš„ï¼Œå½“ç„¶è¿™ä¸ªä¹Ÿä¸éš¾ï¼Œåªè¦ç»§æ‰¿åŸæ¥çš„ Clientï¼Œé‡è½½ç›¸å…³æ–¹æ³•ï¼Œè®°å½•è¯·æ±‚æ•°æ®ï¼Œç„¶åè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œå†è®°å½•å“åº”æ•°æ®å°±å¯ä»¥äº†ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentAPIClient</span><span class="p">(</span><span class="n">APIClient</span><span class="p">):</span>
    <span class="n">test_method_name</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">running_module</span> <span class="o">=</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">make_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_method_name</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">function</span>
        <span class="k">if</span> <span class="n">make_doc</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">"serializer_gen_doc"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># kwargs ä¸­çš„é¢å¤–å‚æ•°ï¼Œåœ¨ view ä¸­ request.META ä¸­å¯ä»¥å–åˆ°ï¼Œç±»ä¼¼é¢å¤–çš„ HTTP å¤´</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">make_doc</span><span class="p">:</span>
            <span class="c"># è®°å½• API è¯·æ±‚å’Œå“åº”</span>
            <span class="k">pass</span>

<span class="k">class</span> <span class="nc">APITestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">client_class</span> <span class="o">=</span> <span class="n">DocumentAPIClient</span>
</code></pre></div></div>

<p>æœ‰å‡ ç‚¹æ˜¯è¦æ³¨æ„çš„</p>

<ul>
  <li>
    <p>æµ‹è¯•ç”¨ä¾‹å­˜åœ¨åµŒå¥—å…³ç³»çš„æ—¶å€™ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">test_edit_acl_rule</code> ä¸­ï¼Œæˆ‘ä»¬åªå…³å¿ƒæœ¬æµ‹è¯•ä¸­å‘é€çš„è¯·æ±‚ï¼Œè€Œä¸å…³å¿ƒè°ƒç”¨çš„ <code class="highlighter-rouge">test_create_acl_rule</code> ä¸­å‘é€çš„è¯·æ±‚ï¼Œæ‰€ä»¥ Client éœ€è¦æ ¹æ®ä»£ç è°ƒç”¨æ ˆæ¥åˆ¤æ–­è‡ªå·±çš„ä½ç½®ã€‚</p>

    <p>è¯·æ±‚æ˜¯åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„ <code class="highlighter-rouge">test_create_acl_rule</code> ä¸­å‘å‡ºçš„ï¼Œé‚£ä¹ˆå‡½æ•°æ ˆæ˜¯</p>

    <ul>
      <li>self._request(0)</li>
      <li>self.postâ€¦(1)</li>
      <li>test_create_acl_rule(2)</li>
    </ul>

    <p><code class="highlighter-rouge">test_edit_acl_rule</code> ä¸­è°ƒç”¨äº† <code class="highlighter-rouge">test_create_acl_rule</code> æ—¶ï¼Œ<code class="highlighter-rouge">self.test_method_name == "test_edit"</code>ï¼Œè€Œå‡½æ•°æ ˆæ˜¯</p>

    <ul>
      <li>self._request(0)</li>
      <li>self.postâ€¦(1)</li>
      <li>test_create_acl_rule(2)</li>
      <li>test_edit_acl_rule(3)</li>
    </ul>
  </li>
  <li>
    <p>ä¸æ˜¯æ‰€æœ‰çš„ API éƒ½æ˜¯å¯ JSON çš„ï¼Œæ¯”å¦‚ä¸Šä¼ æˆ–è€…ä¸‹è½½æ–‡ä»¶çš„è¯·æ±‚ï¼Œç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™éœ€è¦ç‰¹ä¾‹å¤„ç†ä¸‹ã€‚å¯ä»¥å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„ JSON Encoder æ¥å®ç°ã€‚</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">class</span> <span class="nc">MultipartToJsonLikeEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
             <span class="k">return</span> <span class="s">"&lt;æ–‡ä»¶ä¸Šä¼  ğŸ’¾ &gt;"</span>
         <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™è¦æ’åºï¼Œå°†å“åº”æ­£ç¡®çš„æ’åœ¨å‰é¢ï¼Œå“åº”é”™è¯¯çš„æ’åœ¨åé¢ã€‚</p>
  </li>
</ul>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>è§£å†³äº†å·²æœ‰çš„é—®é¢˜ï¼Œè€Œä¸”é¼“åŠ±å¼€å‘è€…è®¤çœŸçš„å»å†™æ›´è§„èŒƒçš„æµ‹è¯•</p>

<ul>
  <li>ä¸ºäº†ç”Ÿæˆæ–‡æ¡£ï¼Œè‡³å°‘ä¼šå†™ä¸€ä¸ªç®€åŒ–ç‰ˆæµ‹è¯•ï¼Œæ€»æ¯”æ²¡æœ‰æµ‹è¯•è¦å¥½</li>
  <li>ä¸€ä¸ªæµ‹è¯•åªå¹²ä¸€ä»¶äº‹æƒ…ï¼Œå¦åˆ™ç”Ÿæˆçš„æ–‡æ¡£ä¼šæœ‰é‡å¤</li>
  <li>æµ‹è¯•ä¸­ä¼šå†™æ³¨é‡Šæ ‡æ˜æµ‹è¯•çš„ç”¨é€”</li>
</ul>



        <section class="author-detail">
            <section class="post-footer-item comment">
                <a href="/comment.html?title=%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E6%96%87%E6%A1%A3%E5%9C%A8%E5%90%8E%E7%AB%AF+API+%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5&article_id=/index.php/archives/772/" target="_blank">è¯„è®º</a> | <a href="#" onclick="document.getElementById('wx-pay').style.display = ''; return false;">å¾®ä¿¡æ‰“èµ</a> | è½¬è½½å¿…é¡»æ³¨æ˜åŸæ–‡é“¾æ¥
            </section>
            <img src="https://storage.virusdefender.net/blog/images/utils/wx_pay_new.JPG" style="max-width: 50%;max-height: 50%; display: none;" id="wx-pay">
        </section>
    </article>
</div>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e5ec0a55646c7c7c90dc530c56c80171";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<footer class="g-footer">
    <section>virusdefender's blog (ï¼¾ï¼ï¼¾)V Â© 2021</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>


    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.virusdefender.net/assets/js/prism.js"></script>
    <script src="https://cdn.virusdefender.net/assets/js/index.min.js"></script>
</body>
</html>