<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-language" content="zh-cn">
    <title>æµé‡æ§åˆ¶ç®—æ³• - virusdefender's blog (ï¼¾ï¼ï¼¾)V</title>
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <meta name="author"  content="virusdefender">
    <meta name="description" content=" å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†">
    <meta name="keywords"  content="virusdefender,blog">
    <!-- Open Graph -->
    <meta property="og:title" content="æµé‡æ§åˆ¶ç®—æ³• - virusdefender's blog (ï¼¾ï¼ï¼¾)V">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://strcpy.me/index.php/archives/548/">
    <meta property="og:description" content=" å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæ€è€Œä¸å­¦åˆ™æ®†">
    <meta property="og:site_name" content="virusdefender's blog (ï¼¾ï¼ï¼¾)V">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="https://strcpy.me/feed/" />
</head>

<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
<![endif]-->
    <header class="g-header">
    <div class="g-logo">
        <a href="/">virusdefender's blog (ï¼¾ï¼ï¼¾)V</a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/index.php/archives/about/">about</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
             
            
            <a href="/tags/#å…¶ä»–" class="post-tag">å…¶ä»–</a>
            
            
        </div>
        <h1>æµé‡æ§åˆ¶ç®—æ³•</h1>
        <div class="post-meta">
            <time class="post-meta-item" datetime="2015-10-25 19:24"><i class="iconfont icon-date"></i>2015-10-25 19:24</time>
        </div>
    </div>
</header>

<div class="post-content">
    
    <article class="markdown-body">
        <p>å¾ˆå¤šåœºæ™¯ä¸‹éƒ½éœ€è¦æµé‡æ§åˆ¶ï¼Œä»åº•å±‚çš„æ•°æ®åŒ…ä¼ è¾“åˆ°è´­ç‰©ç§’æ€ã€‚</p>

<p>å¸¸è§çš„æµé‡æ§åˆ¶ç®—æ³•æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯æ¼æ¡¶ç®—æ³•ï¼Œæ¡¶æœ¬èº«å…·æœ‰ä¸€ä¸ªæ’å®šçš„é€Ÿç‡å¾€ä¸‹æµæ°´ï¼Œè€Œä¸Šæ–¹ä¸€ç›´æœ‰æ°´è¿›å…¥æ¡¶ä¸­ã€‚å½“æ¡¶è¿˜æœªæ»¡æ—¶ï¼Œä¸Šæ–¹çš„æ°´å¯ä»¥åŠ å…¥ã€‚ä¸€æ—¦æ°´æ»¡ï¼Œä¸Šæ–¹çš„æ°´å°±æº¢å‡ºï¼Œå¯ä»¥è®¤ä¸ºè¯·æ±‚è¢«ä¸¢å¼ƒã€‚</p>

<p>è¿™ä¸ªç®—æ³•ä¸éš¾ç†è§£ï¼Œå¯ä»¥ä¿è¯ç³»ç»Ÿçš„ç¨³å®šï¼Œå› ä¸ºæ°´æµå‡ºçš„é€Ÿåº¦ä¸€ç›´æ˜¯ä¸å˜çš„ï¼Œå³ä½¿åœ¨æœ‰çªå‘æµé‡çš„æƒ…å†µä¸‹ã€‚ä½†æ˜¯å¦‚æœåˆ°äº†ç½‘ç«™ç§’æ€çš„æƒ…å¢ƒä¸‹ï¼Œæœ‰çªå‘æµé‡ï¼Œè¿™ä¸ªç®—æ³•å°±ä¸å¥½ç”¨äº†ã€‚æ›´å¸¸ç”¨çš„æ˜¯ä»¤ç‰Œé€šç®—æ³•ã€‚</p>

<p>ä»¤ç‰Œæ¡¶è¿˜æ˜¯å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªç››æ»¡äº†ä»¤ç‰Œçš„ç®±å­ï¼Œæ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚å°±ä¼šæ‹¿èµ°ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œæ²¡æœ‰äº†ï¼Œè¯·æ±‚å°±ä¼šå¤±è´¥ã€‚è€Œæ ¹æ®é€Ÿç‡é™åˆ¶ï¼Œä»¤ç‰Œè¿˜æ˜¯ä¸€ç›´åœ¨æ·»åŠ çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰ä¸€éƒ¨åˆ†çš„è¯·æ±‚æ˜¯å¯ä»¥æ…¢æ…¢çš„æ‹¿åˆ°ä»¤ç‰Œçš„ã€‚è€Œä¸€å¼€å§‹ç®±å­é‡Œé¢æ˜¯æœ‰ä¸€äº›ä»¤ç‰Œçš„ï¼Œä¸€å¼€å§‹çš„çªå‘æµé‡éƒ½å¯ä»¥æˆåŠŸçš„æ‹¿åˆ°ä»¤ç‰Œã€‚</p>

<p>æ ¹æ® https://github.com/celery/kombu/blob/master/kombu/utils/limits.py ï¼Œ æˆ‘ç®€å•æ”¹å†™äº†ä¸€ä¸‹ï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹å‡ºæ¥æµé‡æ§åˆ¶ç»“æœã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># coding=utf-8</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">TokenBucket</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_rate</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">capacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fill_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">"""Return :const:`True` if the number of tokens can be consumed
        from the bucket.  If they can be consumed, a call will also consume the
        requested number of tokens from the bucket. Calls will only consume
        `tokens` (the number requested) or zero tokens -- it will never consume
        a partial number of tokens."""</span>
        <span class="k">if</span> <span class="n">tokens</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span> <span class="o">-=</span> <span class="n">tokens</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">expected_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">"""Return the time (in seconds) when a new token is expected
        to be available. This will not consume any tokens from the bucket."""</span>
        <span class="n">_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">_tokens</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tokens</span> <span class="o">-</span> <span class="n">_tokens</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_tokens</span>


<span class="n">true</span> <span class="o">=</span> <span class="n">false</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c"># æ¯ç§’å¾€æ¡¶é‡Œé¢æ·»åŠ 5ä¸ªä»¤ç‰Œï¼Œæ¡¶çš„å¤§å°æ˜¯50</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">TokenBucket</span><span class="p">(</span><span class="n">fill_rate</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
        <span class="n">true</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">"Accepted"</span><span class="p">,</span> <span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">false</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">"Dropped, time left "</span><span class="p">,</span> <span class="n">bucket</span><span class="o">.</span><span class="n">expected_time</span><span class="p">()</span>
<span class="k">print</span> <span class="n">true</span><span class="p">,</span> <span class="n">false</span>
</code></pre></div></div>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä¸Šé¢çš„demoä»£ç æ˜¯å­˜åœ¨å­˜åœ¨å¹¶å‘ç«æ€æ¡ä»¶é—®é¢˜çš„ï¼Œä½†æ˜¯å‡ºäºæ€§èƒ½å’Œç®€åŒ–å†™æ³•çš„è€ƒè™‘ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥æ¥å—çš„ï¼Œæ¯•ç«Ÿæµé‡é™åˆ¶ä¸€èˆ¬ä¹Ÿä¸éœ€è¦å¤ªç²¾ç¡®ã€‚</p>


        <section class="author-detail">
            <section class="post-footer-item comment">
                <a href="/comment.html?title=æµé‡æ§åˆ¶ç®—æ³•&article_id=/index.php/archives/548/" target="_blank">è¯„è®º</a> | <a href="#" onclick="document.getElementById('wx-pay').style.display = ''; return false;">å¾®ä¿¡æ‰“èµ</a> | è½¬è½½å¿…é¡»æ³¨æ˜åŸæ–‡é“¾æ¥
            </section>
            <img src="https://storage.virusdefender.net/blog/images/utils/wx_pay_new.JPG" style="max-width: 90%;max-height: 90%; display: none;" id="wx-pay">
        </section>
    </article>
</div>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e5ec0a55646c7c7c90dc530c56c80171";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<footer class="g-footer">
    <section>virusdefender's blog (ï¼¾ï¼ï¼¾)V Â© 2020</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>


    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/index.min.js"></script>
</body>
</html>